name: Draft episode description

on:
  issues:
    types: [labeled]
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *" # safety net in case an event is missed

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

concurrency:
  group: draft-descriptions
  cancel-in-progress: false

jobs:
  draft:
    # Run when:
    # - issue gets labeled "status: queued"
    # - manual dispatch
    # - scheduled run
    if: |
      github.event_name != 'issues' ||
      (github.event.action == 'labeled' && github.event.label.name == 'status: queued')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select oldest queued issue
        id: pick
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner,
                repo,
                labels: "status: queued",
                state: "open",
                per_page: 100,
                sort: "created",
                direction: "asc"
              }
            );

            if (!issues.length) {
              core.setOutput("issue_number", "");
              core.info("No queued issues.");
              return;
            }

            const issue = issues[0];
            core.setOutput("issue_number", String(issue.number));
            core.info(`Picked issue #${issue.number}: ${issue.title}`);

      - name: Stop if nothing queued
        if: steps.pick.outputs.issue_number == ''
        run: echo "Queue empty."

      - name: Claim issue (queued → processing)
        if: steps.pick.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = Number("${{ steps.pick.outputs.issue_number }}");

            // Remove queued label (ignore if already removed)
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number,
                name: "status: queued"
              });
            } catch (_) {}

            // Add processing label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ["status: processing"]
            });

      - name: Setup Python
        if: steps.pick.outputs.issue_number != ''
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: steps.pick.outputs.issue_number != ''
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Draft description + create PR
        if: steps.pick.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ISSUE_NUMBER: ${{ steps.pick.outputs.issue_number }}
          REPO: ${{ github.repository }}
        run: |
          python scripts/generate_description.py

      - name: Mark complete (processing → needs-review)
        if: steps.pick.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = Number("${{ steps.pick.outputs.issue_number }}");

            // Remove processing label (ignore if missing)
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number,
                name: "status: processing"
              });
            } catch (_) {}

            // Add needs-review label
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number,
              labels: ["status: needs-review"]
            });

      - name: Dispatch next run if queue remains
        if: steps.pick.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            const remaining = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner,
                repo,
                labels: "status: queued",
                state: "open",
                per_page: 1
              }
            );

            if (remaining.length) {
              core.info("Queue not empty — dispatching next run...");
              await github.rest.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: "draft.yml",  // <-- set this to your workflow filename
                ref: context.ref
              });
            } else {
              core.info("Queue drained.");
